module.exports = function(grunt) {

    var Utils = require('../lib/utils');

    grunt.registerMultiTask('mobify-upload', 'Upload builds to the Mobify Cloud', function() {
        var done = this.async();

        var archivePath = 'build.tar';
        var options = this.options({
            projectSlug: '',
            settingsFile: Utils.getSettingsPath(),
            origin: 'https://cloud.mobify.com'
        });

        function uploadArchive() {
            var requestOptions = {
                projectSlug: options.projectSlug,
                origin: options.origin
            };

            requestOptions.auth = Utils.readCredentials(options.settingsFile);

            // Check build path, then create the build object
            if (!grunt.file.exists(archivePath)) {
                grunt.fail.warn('Specified path "' + archivePath + '" not found.');
                return false;
            }

            var buildObj = Utils.buildObject(archivePath, options.message);

            var buildJSON = JSON.stringify(buildObj, null, 4);
            var dataBuffer = new Buffer(buildJSON);

            requestOptions.dataLength = dataBuffer.length;

            var request = Utils.buildRequest(requestOptions, done);
            request.end(dataBuffer);
        }

        Utils.createBundle(this.filesSrc, options.projectSlug, archivePath, uploadArchive);
    });
};
